typedef unsigned int u32;
typedef volatile u32 vu32;

#define PXI_CALLBACK_TABLE		((vu32*)0x27BA1BC)

#define PXI_TARGET_TAG	25

#define IPC_FIFO_SEND	(*((vu32*)0x04000188))

#define UNCACHED_CODE_TARGET	0x02FFC000

#define ARM9_WAIT_ADDRESS	*(vu32 *)0x02FFFE24

#define ARM9_EXCEPTION_VECTOR	(*((vu32*)0x02FFFD9C))

#define VRAM_LOCATION 0x06000000

extern u32 arm9_code[];
extern u32 arm9_code_end[];

extern u32 bootloader[];
extern u32 bootloader_end[];

int main()
{
	ARM9_EXCEPTION_VECTOR = UNCACHED_CODE_TARGET;
	u32 code_length = (u32)arm9_code_end - (u32)arm9_code;
	u32 i;
	for (i = 0; i < code_length; i++)
		((vu32*)UNCACHED_CODE_TARGET)[i] = arm9_code[i];

	PXI_CALLBACK_TABLE[PXI_TARGET_TAG] = UNCACHED_CODE_TARGET;

	IPC_FIFO_SEND = PXI_TARGET_TAG;

	while(ARM9_WAIT_ADDRESS);

	u32 bootloader_length = (u32)bootloader_end - (u32)bootloader;
	for (i = 0; i < bootloader_length; i++)
		((vu32*)VRAM_LOCATION)[i] = bootloader[i];

	return 0;
}

